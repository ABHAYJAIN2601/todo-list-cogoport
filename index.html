<!DOCTYPE html>
<html>

<head>
   <title>todo-list</title>
   <link href='https://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet'>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous" />
   <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.4.0/css/all.css" />
   <link rel="stylesheet" href='./index.css' />
</head>

<body>
   <div class="todo-app">
      <!-- <h1 class="title">To-do list</h1> -->
      <!-- <p class="qoute">“Each day I will accomplish one thing on my to do list.”</p> -->
      <div class="upper-section">
         <div class="upper-1">
            <button class="button blue" onclick="openModel()">Add Task</button>
         </div>
         <div id="model" class="model">
            <div class="model-content">
               <div class="input-section">
                  <div>
                     <input class="input" id="todoInput" type="text" placeholder="Add item..." />
                     <div class="priority-category">
                        <div>
                           <label for="prioritySelect">Priority</label>
                           <select id="prioritySelect" class="filter_select">
                              <option value="1">Low</option>
                              <option value="2">Medium</option>
                              <option value="3">High</option>
                           </select>
                        </div>
                        <div>
                           <label for="categorySelect">Category</label>
                           <select id="categorySelect" class="filter_select">
                              <option value="development">Development</option>
                              <option value="frontend">Frontend</option>
                              <option value="backend">Backend</option>
                              <option value="product-management">Product Management</option>
                           </select>
                        </div>
                     </div>

                  </div>
                  <div>
                     <label for="dueDate">Due Date</label>
                     <input class="input" type="date" id="dueDate" />
                     <label for="dueDate">Reminder Date</label>
                     <input class="input" type="date" id="reminderDate" />
                  </div>
                  <div>
                     <input class="input" type="text" id="subtask" placeholder="Enter subtask here"
                        onkeydown="addSubtaskEnter(event)">
                     <button class="button" onclick="addSubtask()">Add Subtask</button>
                     <ul id="subtask_name">
                     </ul>
                  </div>
               </div>
               <div>
                  <button id="addBtn" type="submit" class="button green">Save</button>
                  <button class="button red" onclick="closeModel()">Close</button>
               </div>
            </div>
         </div>
         <div class="upper-2">
            <label for="search_by">Search By</label>
            <select id="search_by" class="filter_select">
               <!-- <option value="all">All</option> -->
               <option value="title">Title</option>
               <option value="subtask">SubTask</option>
               <option value="tags">Tags</option>
            </select>
            <input class="input" type="text" id="search-input" placeholder="Search" />
            <button class="button red" type="button" id="search-button">Search</button>
         </div>
         <div class="filter_section">
            <label for="dueDate">Due Date</label>
            <input class="input" type="date" id="dueDate">
            <label for="filter_label">Category</label>
            <select id="filter_category" class="filter_select">
               <option value="all">All</option>
               <option value="development">Development</option>
               <option value="frontend">Frontend</option>
               <option value="backend">Backend</option>
               <option value="product-management">Product Management</option>
            </select>
            <!-- Select input field for priority -->
            <label for="filter_priority">Priority</label>
            <select id="filter_priority" class="filter_select">
               <option value="all">All</option>
               <option value="1">Low</option>
               <option value="2">Medium</option>
               <option value="3">High</option>
            </select>
            <button class="button" onclick="displayFilteredTodos()" class="filter_button">Filter</button>
         </div>
         <!-- Select input field for category -->
         <!-- Select input field for sorting -->
         <div>
            <label for="sorting">Sort By</label>
            <select id="sort_sorting" class="filter_select">
               <option value="none">None</option>
               <option value="dueDate">Due Date</option>
               <option value="priority">Priority</option>
            </select>
            <!-- Button to trigger sorting -->
            <button class="button" onclick="sortTodos()">Sort</button>
         </div>
         <div class='upper-4'>
            <button class="button" onclick="viewBacklogs()">View Backlogs</button>
            <button class="button red" onclick="reset()">Reset</button>
            <button class="button green" onclick="activityLog()">Activity Log</button>
         </div>
      </div>
      <div class="todos">
         <ul class="todo-list">
         </ul>
      </div>
   </div>
</body>
<script>
   const priorityMapping = {
      "1": "low",
      "2": "medium",
      "3": "high"
   };
   // Function to open the model
   let subtasks = [];
   function addSubtaskEnter(event) {
      if (event.key === 'Enter') {
         addSubtask();
      }
   }

   function addSubtask() {
      const subtaskInput = document.getElementById("subtask");
      const subtask = subtaskInput.value;
      if (subtask == '') return;
      const subtaskText = document.getElementById("subtask_name");

      const element = document.createElement('li');
      element.className = "tag-container";
      element.innerText = subtask;
      element.addEventListener('click', () => removeSubTask(subtasks.length));
      subtaskText.appendChild(element);
      // Add the subtask to the subtasks array
      subtasks.push({subtask,completed:false,completed_at:null});

      // Clear the subtask input field
      subtaskInput.value = "";
   }

   function openModel() {
      var model = document.getElementById("model");
      model.style.display = "block";
   }

   function renderSubtask() {
      const subtaskText = document.getElementById("subtask_name");
      subtaskText.innerHTML = "";
      subtasks.forEach((subtask, index) => {
         console.log(subtask)
         const element = document.createElement('li');
         element.classList = "tag-container";
         element.innerText = subtask.subtask;
         const crossSpan = document.createElement('span');
         crossSpan.innerHTML = '<i class="fa-regular fa-circle-xmark"></i>';

         // </span>  click = "${() => removeSubTask(index)}"></i>`;
         crossSpan.addEventListener('click', () => removeSubTask(index));
         subtaskText.appendChild(element);
         subtaskText.appendChild(crossSpan);
      });
   }

   function removeSubTask(id) {

      subtasks.splice(id, 1);
      renderSubtask();

   }
   // Function to close the model
   function closeModel() {
      var model = document.getElementById("model");
      model.style.display = "none";
   }

   function reset() {
      displayTodos(todos);
   }

   let todos = JSON.parse(localStorage.getItem("todos")) || [];
   let editIndex = -1;
   const todoForm = document.querySelector(".input-section");
   const todoInput = document.querySelector("#todoInput");
   const todoList = document.querySelector(".todo-list");
   const addButton = document.querySelector("#addBtn");
   const todo_main = document.querySelector(".todos");
   const searchBy = document.getElementById("search_by");
   const searchInput = document.getElementById("search-input");
   const searchButton = document.getElementById("search-button");
   const prioritySelect = document.getElementById("prioritySelect");
   const categorySelect = document.getElementById("categorySelect");
   const dueDateInput = document.getElementById("dueDate");
   const reminderDateInput = document.getElementById("reminderDate");

   function saveTodos() {
      localStorage.setItem("todos", JSON.stringify(todos));
   }

   // Function to sort todos based on selected criteria
   function sortTodos() {
      const sortingCriteria = document.getElementById("sort_sorting").value;
      let sortedTodos = [];

      if (sortingCriteria === "none") {
         // If no sorting criteria selected, show all todos
         sortedTodos = todos;
      } else if (sortingCriteria === "dueDate") {
         // Sort todos by due date
         sortedTodos = todos.slice().sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
      } else if (sortingCriteria === "priority") {
         // Sort todos by priority (assuming priority is represented as a numerical value, e.g., 1 for low, 2 for medium, 3 for high)
         sortedTodos = todos.slice().sort((a, b) => a.priority - b.priority);
      }

      // Display the sorted todos in the todo list
      displayTodos(sortedTodos);
   }

   // Function to display todos in the todo list
   function displayTodos(todoArray) {
      todoList.innerHTML = "";
      // Display the filtered todos in the todo list
      if (todoArray.length > 0) {
         todoArray.forEach((todo, index) => {
            const id = index;
            const li = document.createElement("li");
            li.className = "li draggable";
            li.setAttribute('id', index);
            const checkbox = document.createElement("input");
            checkbox.className = "form-check-input";
            checkbox.type = "checkbox";
            checkbox.checked = todo.completed;
            checkbox.addEventListener("change", () => toggleTodoCompleted(index));

            const label = document.createElement("label");
            label.className = "form-check-label";

            const spanText = document.createElement("span");
            spanText.className = "todo-text";
            spanText.id = 'todoText';
            todoText = `${todo.title}`;
            if (todo.due_date != undefined)
               todoText += `( Due: ${todo.due_date}) `;
            if (todo.reminder_date != "")
               todoText += ` (Reminder: ${todo.reminder_date})`;

            spanText.innerHTML = todoText;


            const subtaskUl = document.createElement('ul');

            if (todo.subtasks.length > 0) {
               todo.subtasks.forEach((subtask, index) => {
                  const checkbox = document.createElement("input");
            checkbox.className = "form-check-input";
            checkbox.type = "checkbox";
            checkbox.checked = subtask.completed;
            checkbox.addEventListener("change", () => toggleSubTaskCompleted(id,index));
                  const subTaskLi = document.createElement('li');
                  const span = document.createElement('span');
                  span.setAttribute('id', `${id}-${index}`);
                  span.classList = 'draggable-subtask';
                  span.innerHTML = subtask.subtask;
                  subTaskLi.appendChild(checkbox);
                  subTaskLi.appendChild(span);
                  subtaskUl.appendChild(subTaskLi);
               });
            }

            const priority = document.createElement("span");
            priority.className = "tag-container " + priorityMapping[todo.priority];
            priority.id = 'todoText';
            priority.textContent = priorityMapping[todo.priority];

            const category = document.createElement("span");
            category.className = "tag-container";
            category.id = 'todoText';
            category.textContent = todo.category;

            const deleteButton = document.createElement("span");
            deleteButton.className = "span-button";
            deleteButton.innerHTML = '<i class="fa-solid fa-trash"></i>';
            deleteButton.id = 'delete-button';
            deleteButton.addEventListener("click", () => deleteTodo(index));

            const editButton = document.createElement("span");
            editButton.className = "span-button";
            editButton.id = 'editButton'
            editButton.innerHTML = '<i class="fa-solid fa-pen"></i>';
            editButton.addEventListener("click", () => editTodo(index));

            const addSubtaskButton = document.createElement("span");
            addSubtaskButton.className = "span-button";
            addSubtaskButton.id = 'addSubtaskButton'
            addSubtaskButton.innerHTML = '<i class="fa-solid fa-plus"></i>';
            addSubtaskButton.addEventListener("click", () => addSubtask(index));
            
            const updateButton = document.createElement("button");
            updateButton.className = "span-button";
            updateButton.innerHTML = 'Save';
            updateButton.id = "update-button";
            updateButton.style.display = 'none';
            updateButton.addEventListener("click", () => addTodo());

            li.appendChild(checkbox);
            li.appendChild(label);
            li.appendChild(spanText);
            // li.appendChild(subtaskUl);
            li.appendChild(priority);
            li.appendChild(category);
            li.appendChild(editButton);
            li.appendChild(updateButton);
            li.appendChild(deleteButton);
            li.appendChild(addSubtaskButton);

            todoList.appendChild(li);
            todoList.appendChild(subtaskUl);
         });
      } else {
         todoList.innerHTML = `<img class="face" src="asetes/thinking.png" alt="">
                            <h1 class="not-found"> NOT FOUND</h1>`;
      }
      makeItemsDraggable();
   }

   function activityLog() {
      todoList.innerHTML = "";

      todos.forEach((todo, index) => {

         if (todo.completed == true) {
            const li = document.createElement("li");
            li.className = "li";
            li.setAttribute('id', index);
            const spanText = document.createElement("span");
            spanText.className = "todo-text";
            spanText.id = 'todoText';
            todoText = `${todo.title} (Due: ${todo.due_date}) completed on ${todo.completed_at} of priority ${priorityMapping[todo.priority]} and category ${todo.category}`;
            spanText.innerHTML = todoText;



            li.appendChild(spanText);

            todoList.appendChild(li);
         }

      });

   }
   // Function to view backlogs (pending or missed tasks)
   function viewBacklogs() {
      const backlogTodos = todos.filter(todo => todo.completed != true);

      // Display the backlogs in the todo list
      displayTodos(backlogTodos);
   }


   function displayFilteredTodos() {

      // Clear existing todos from the list
      todoList.innerHTML = "";

      // Get the selected filter values
      const categoryFilter = document.getElementById("filter_category").value;
      const priorityFilter = document.getElementById("filter_priority").value;

      // Filter todos based on the selected filters
      const filteredTodos = todos.filter(todo => {
         const categoryMatch = categoryFilter === "all" || todo.category === categoryFilter;
         const priorityMatch = priorityFilter === "all" || todo.priority === priorityFilter;
         return categoryMatch && priorityMatch;
      });
      displayTodos(filteredTodos);
   }


   function makeItemsDraggable() {
      const draggableItems = document.querySelectorAll(".draggable");
      draggableItems.forEach(item => {
         item.draggable = true;

         item.addEventListener("dragstart", dragStart);
         item.addEventListener("dragover", dragOver);
         item.addEventListener("drop", drop);
      });
      const draggableSubtask = document.querySelectorAll(".draggable-subtask");
      draggableSubtask.forEach(item => {
         item.draggable = true;

         item.addEventListener("dragstart", dragSubtaskStart);
         item.addEventListener("dragover", dragSubtaskOver);
         item.addEventListener("drop", dropSubtask);
      });
   }

   function dragSubtaskStart(event) {
      event.dataTransfer.setData("text/plain", event.target.id);
   }

   // Function to handle drag over
   function dragSubtaskOver(event) {
      event.preventDefault();
   }

   // Function to handle drop
   function dropSubtask(event) {
      event.preventDefault();
      const data = event.dataTransfer.getData("text/plain");
      const draggedSubtsk = data.split("-");

      const draggedOverSubtask = event.target.id.split('-');

      // Check if dropped item is a subtask

      console.log(draggedSubtsk, draggedOverSubtask);
      var b = todos[draggedSubtsk[0]].subtasks[draggedSubtsk
      [1]];
      todos[draggedSubtsk[0]].subtasks[draggedSubtsk
      [1]] = todos[draggedOverSubtask[0]].subtasks[draggedOverSubtask[1]];
      todos[draggedOverSubtask[0]].subtasks[draggedOverSubtask[1]] = b;
      saveTodos();
      displayTodos(todos);
   }
   // Function to handle drag start
   function dragStart(event) {
      event.dataTransfer.setData("text/plain", event.target.id);
   }

   // Function to handle drag over
   function dragOver(event) {
      event.preventDefault();
   }

   // Function to handle drop
   function drop(event) {
      event.preventDefault();
      const data = event.dataTransfer.getData("text/plain");

      const draggableItem = document.getElementById(data);
      // Check if dropped item is a subtask
      const isSubtask = event.target.parentElement.className == "li draggable";
      // console.log(data, event.target.parentElement, event.target.parentElement.className);
      if (isSubtask) {
         var b = todos[data];
         todos[data] = todos[event.target.parentElement.id];
         todos[event.target.parentElement.id] = b;
         saveTodos();
         displayTodos(todos);
      }
   }

   // Call the makeItemsDraggable function when the page loads
   window.addEventListener("load", makeItemsDraggable);

   function parseDueDate(dueDateStr) {
      // Use any date parsing library or custom logic here to convert due date string to date object
      // For simplicity, we'll use JavaScript's Date object for basic date parsing

      // Check if the due date is "today"
      if (dueDateStr.toLowerCase() === "today") {
         return new Date();
      }

      // Check if the due date is "tomorrow"
      if (dueDateStr.toLowerCase() === "tomorrow") {
         const tomorrow = new Date();
         tomorrow.setDate(tomorrow.getDate() + 1);
         return tomorrow;
      }

      // Parse date using JavaScript Date object (for example, for date format "13th Jan 2023 3 pm")
      const parsedDate = new Date(dueDateStr);
      return parsedDate;
   }
   function addTodo() {
      const todoText = todoInput.value.trim();
      todoForm.addEventListener("click", function (event) {
         event.preventDefault()
      });
      const dueDateMatch = todoText.match(/\b(?:tomorrow|today|\d{1,2}(?:st|nd|rd|th)? (?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) \d{4}(?: \d{1,2}(?::\d{2})? [ap]m)?)\b/i);

      let dueDate;
      if (dueDateMatch) {
         // If due date is found, convert it to a date object
         dueDate = parseDueDate(dueDateMatch[0]);
      }

      // Remove the due date from the todo text
      const todoTextWithoutDate = dueDateMatch ? todoText.replace(dueDateMatch[0], '').trim() : todoText;
      // console.log(todoTextWithoutDate, dueDate);

      if (todoText == '' && editIndex == -1) return false;

      if (editIndex === -1) {
         todos.unshift({
            title: todoTextWithoutDate,
            completed: false,
            priority: prioritySelect.value,
            category: categorySelect.value,
            due_date: dueDate,
            reminder_date: reminderDateInput.value,
            subtasks: subtasks
         });
      } else {
         todos[editIndex].title = todoTextWithoutDate;
         todos[editIndex].priority = prioritySelect.value;
         todos[editIndex].category = categorySelect.value;
         todos[editIndex].due_date = dueDateInput.value;
         todos[editIndex].reminder_date = reminderDateInput.value,
            editIndex = -1;
         addButton.style.display = "inline";
      }
      todoInput.value = "";
      subtasks = [];
      prioritySelect.value = '1';
      categorySelect.value = 'development';
      dueDateInput.value = null;
      saveTodos();
      closeModel();
      renderSubtask();
      displayTodos(todos);




   }

   function editTodo(id) {
      openModel();
      todoInput.value = todos[id].title;

      prioritySelect.value = todos[id].priority;
      categorySelect.value = todos[id].category;
      dueDateInput.value = todos[id].due_date;
      subtasks = todos[id].subtasks;
      renderSubtask();



      // var elements = document.getElementById(id);
      // let editButton = elements.querySelector('#editButton');
      // editButton.style.display = 'none';
      // let updateButton = elements.querySelector('#update-button');
      // updateButton.style.display = 'block';
      // let taskTitle = elements.querySelector('#todoText');
      // taskTitle.style.display = 'none';
      // let editInput = elements.querySelector('#editInput');
      // editInput.style.display = 'block';
      // let deleteButton = elements.querySelector('#delete-button');
      // deleteButton.style.display = 'none';
      editIndex = id;
   }

   function toggleTodoCompleted(id) {
      todos[id].completed = !todos[id].completed;
      todos[id].completed_at = new Date().toISOString().split('T')[0];
      saveTodos();
      displayTodos(todos);
   }
   function toggleSubTaskCompleted(id,index) {
      console.log(id,index);
      todos[id].subtasks[index].completed = !todos[id].subtasks[index].completed;
      todos[id].subtasks[index].completed_at = new Date().toISOString().split('T')[0];
      saveTodos();
      displayTodos(todos);
   }
   function deleteTodo(id) {
      todos.splice(id, 1);
      saveTodos();
      displayTodos(todos);
   }

   function searchTodo() {
      const searchQuery = searchInput.value.trim();
      if (searchQuery !== "") {
         if (searchBy.value === 'title') {
            const searchResults = todos.filter((todo) =>
               todo.title.toLowerCase().includes(searchQuery.toLowerCase())
            );
            displayTodos(searchResults);
         } else if (searchBy.value === 'subtask') {
            const searchSubTaskResults =
               todos.map((todo) => {
                  return { ...todo, subtasks: todo.subtasks.filter((subtask) => subtask.toLowerCase().includes(searchQuery.toLowerCase())) }
               })
            //     todos.forEach((todo) => {
            //    todo.subtasks.filter((subtask) => {
            //       subtask.toLowerCase().includes(searchQuery.toLowerCase())
            //    });
            // });
            console.log(searchSubTaskResults);
            displayTodos(searchSubTaskResults);
         }

      } else {
         displayTodos(todos);
      }
   }
   addButton.addEventListener("click", addTodo);
   searchButton.addEventListener("click", searchTodo);

   displayTodos(todos);
</script>

</html>